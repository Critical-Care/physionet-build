{% extends "project/project.html" %}

{% block title %}Project Metadata - {{ project }}{% endblock %}

{% block main_content %}
<h2 class="form-signin-heading">Project Metadata</h2>
<hr>



<script>
  function getCookie(name) {
      var cookieValue = null;
      if (document.cookie && document.cookie !== '') {
          var cookies = document.cookie.split(';');
          for (var i = 0; i < cookies.length; i++) {
              var cookie = jQuery.trim(cookies[i]);
              // Does this cookie string begin with the name we want?
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
              }
          }
      }
      return cookieValue;
  }

  function cloneElement(selector, type, max_forms){
    var newElement = $(selector).clone(true);
    var total_forms = $('#id_' + type + '-TOTAL_FORMS').val();

    if (total_forms < max_forms){
      // Change input names and ids
      newElement.find('input').each(function() {
          var name = $(this).attr('name').replace('-' + (total_forms-1) + '-', '-' + total_forms + '-');
          var id = 'id_' + name;
          $(this).attr({'name': name, 'id': id}).val('').removeAttr('checked');
      });

      total_forms++;
      $('#id_' + type + '-TOTAL_FORMS').val(total_forms);

      // Insert the new content (reference) after the old content
      $(selector).after(newElement);
      $('.ref-number:last').html(total_forms);
    }
  }

  {# Add another reference form #}
  function addReference(){
    // The base name of the reference formset
    var type = 'project-reference-content_type-object_id'
    var total_forms = $('#id_' + type + '-TOTAL_FORMS').val();

    // Clone the existing html
    if (total_forms > 0){
      cloneElement('.ref-body:last', type, 8);
    }
    // Reload the reference section with an additional form
    else{
      var csrftoken = getCookie('csrftoken');
      $.ajax({
              type: "POST",
              url: "{% url 'edit_references' project.id %}",
              data: {'csrfmiddlewaretoken':csrftoken,
                     'add_first':true
              },
              success: function reloadSection(result){
                  $("#reference-list").html(result);
              },
      });
    }
  };


  // Delete a reference form and possibly an object
  function removeReference(trigger_button){

    // Get the reference number, and whether there is an input id value of the form

    var reference_div = trigger_button.parentElement.parentElement

    var form_div = reference_div.getElementsByClassName("ref-form")[0]

    var reference_instance_id = form_div.getElementsByTagName("input")[0].value

    // The reference object has not been saved. Just edit html.
    if (reference_instance_id == ""){

      var reference_number = parseInt(reference_div.id.substring(4));

      var reference_list_div = reference_div.parentElement;

      var reference_divs = reference_list_div.getElementsByClassName("ref-body")

      var num_reference_forms = reference_divs.length;

      // All reference forms with greater numbers must be altered

    }
    // The reference object exists. Send ajax query to remove it and
    // reload page section.
    else{


      var csrftoken = getCookie('csrftoken');
      $.ajax({
              type: "POST",
              url: "{% url 'edit_references' project.id %}",
              data: {'csrfmiddlewaretoken':csrftoken,
                     'remove_reference':reference_instance_id
              },
              success: function reloadSection(result){
                  $("#reference-list").html(result);
              },
      });
    }








    var type = 'project-reference-content_type-object_id';
    var total_forms = $('#id_' + type + '-TOTAL_FORMS').val();

    // Just remove the html for the extra form
    // if (has_instance){
    //   $("#ref-"+reference_number).delete()
    // }
    // // Delete the instance and reload the reference section
    // else{

    //   // Get all the larger references


    //   var csrftoken = getCookie('csrftoken');
    //   $.ajax({
    //           type: "POST",
    //           url: "{% url 'edit_references' project.id %}",
    //           data: {'csrfmiddlewaretoken':csrftoken,
    //                  'remove_reference':reference_id
    //           },
    //           success: function reloadSection(result){
    //               $("#reference-list").html(result);
    //           },
    //   });
    // }
  };

</script>


<form action="{% url 'project_metadata' project.id %}" method="post">
  <h3 class="form-signin-heading">1. Description Metadata</h2>
  <hr>
  {{ description_form.media }}
  {% include 'project/reference_list.html' %}
  <p><button class="btn" type="button" onclick="addReference()" style="background:transparent"><i class="fas fa-plus"></i> Add Reference</button></p>
  <button class="btn btn-lg btn-primary" type="submit" name="edit_description">Save Description</button>
  <br>
  {% include "inline_form_snippet.html" with form=description_form %}


</form>
<br>
<hr>

<form action="{% url 'project_metadata' project.id %}" method="post">
  <h3 class="form-signin-heading">3. Access</h2>
  <hr>
  {# License, access selection #}
  {{ reference_formset.media }}
  {% csrf_token %}

  {% for form in reference_formset %}
    <div class="form-group row">
        <label class="col-md-1">1.</label>
        <div class='col-md-11'>
            {{ form.description }}
        </div>
    </div>
  {% endfor %}

  <button class="btn btn-lg btn-primary" type="submit" name="edit_references">Save Access Information</button>
</form>
<br>

<form action="{% url 'project_metadata' project.id %}" method="post">
  <h3 class="form-signin-heading">4. Identifiers</h2>
  <hr>
  {# Topics, external home page, citations #}
  {{ reference_formset.media }}
  {% csrf_token %}

  {% for form in reference_formset %}
    <div class="form-group row">
        <label class="col-md-1">1.</label>
        <div class='col-md-11'>
            {{ form.description }}
        </div>
    </div>
  {% endfor %}

  <button class="btn btn-lg btn-primary" type="submit" name="edit_references">Save Access Information</button>
</form>
<br>


{% endblock %}
